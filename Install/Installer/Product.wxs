<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <?include $(sys.CURRENTDIR)\Config.wxi?>

    <Product Id="$(var.ProductId)"
			 Name="$(var.ProductName)"
			 Language="$(var.Language)"
			 Version="$(var.Version)"
			 Manufacturer="$(var.Manufacturer)"
			 UpgradeCode="$(var.UpgradeCode)">

        <Package InstallerVersion="200"
                 Compressed="yes"
                 InstallScope="perMachine"
                 InstallPrivileges="elevated"/>

        <!--=
        Disables Install-on-demand shortcuts
        What this is: https://docs.microsoft.com/en-us/windows/win32/msi/disableadvtshortcuts
        
        Why this matters: 
        source - https://stackoverflow.com/questions/2058230/wix-create-non-advertised-shortcut-for-all-users-per-machine
        By default, creating shortcuts for the ALL USERS profile causes a MSI validation errors. There is a validation requirement (ICE43)
        that specifies that non advertised shortcuts (normal shortcuts) must have a HKCU registry entry. ALL USERS does not have a HKCU profile so this
        can't be satified. Seems like a windows installer bug. The example in the link above works around this by
        
        1. Setting a global property to disable advertised shortcuts
        2. Set the advertise property in the shortcut
        
        The effect is this removes the requirement to have a registry entry for the shortcut under HKCU and windows installer will replace the advertised
        shortcut with a normal shortcut
        -->       
        <Property Id="DISABLEADVTSHORTCUTS" Value="1" />

        <Property Id="UC_EVENT_URL" Value="0" />
        <Property Id="UC_EVENT_UCID" Value="0" />
        <Property Id="UC_EVENT_UCID_TOKEN" Value="0" />
        <Property Id="UC_RESOURCE_DIR" Value="0" />
        <Property Id="UCDT_SHORTCUT_NAME" Value="!(loc.DiagToolName).lnk" />
        <Icon Id="UC.ico" SourceFile="$(var.SolutionDir)\Resources\images\UC.ico"/>
        <Property Id="ARPPRODUCTICON" Value="UC.ico" />
        
        <Property Id="REMOVE_CSC_PLUGIN_DATA" Value="0" />
        <Property Id="COPY_CSC_PLUGIN_DATA" Value="0" />
      
        <SetProperty Id="BS_CONFIG" Value="[%PASS_BS_CONFIG]" Before="FindRelatedProducts" >NOT BS_CONFIG</SetProperty>
        
        <Binary Id="CustomActionsDll" SourceFile="$(var.SolutionDir)\Win32\$(var.Configuration)\InstallerCustomActions.dll" />
        <CustomAction Id="ExtractCaResources" BinaryKey="CustomActionsDll" DllEntry="ExtractCaResources" />
        <CustomAction Id="RemoveCaResources" BinaryKey="CustomActionsDll" DllEntry="RemoveCaResources" />
        <CustomAction Id="DetectInvalidSideGrade" BinaryKey="CustomActionsDll" DllEntry="DetectOlderBuildVersion" />
        <CustomAction Id="DetectInvalidOS" BinaryKey="CustomActionsDll" DllEntry="DetectWindows10OrGreater" />
        <CustomAction Id="SetCacheDirectory" Property="UC_INSTALLCACHE_DIR" Value="[WindowsFolder]\Temp\$(var.PmInstallCacheDirectory)" />
        <CustomAction Id="CollectUCData" BinaryKey="CustomActionsDll" DllEntry="CollectUCData" />
        <!--=
        Commenting out this event till we figure out what we want to do with it
        <CustomAction Id="SendEventOnUninstallBegin" BinaryKey="CustomActionsDll" DllEntry="SendEventOnUninstallBegin" />
        -->
        <CustomAction Id="SendEventOnUninstallError" BinaryKey="CustomActionsDll" DllEntry="SendEventOnUninstallError" />
        <CustomAction Id="SendEventOnUninstallComplete" BinaryKey="CustomActionsDll" DllEntry="SendEventOnUninstallComplete" />
        <CustomAction Id="SetupRemoveCscPluginData" BinaryKey="CustomActionsDll" DllEntry="SetupRemoveCscPluginData" />
        <CustomAction Id="RemoveCscPlugin" BinaryKey="CustomActionsDll" DllEntry="RemoveCscPlugin" Execute="deferred" Impersonate="no" />
        <SetProperty Id="RemoveCscPlugin" Before="RemoveCscPlugin" Value="[REMOVE_CSC_PLUGIN_DATA]" Sequence="execute"/>
        <CustomAction Id="SetupCopyCscPluginData" BinaryKey="CustomActionsDll" DllEntry="SetupCopyCscPluginData" />
        <CustomAction Id="CopyCscPlugin" BinaryKey="CustomActionsDll" DllEntry="CopyCscPlugin" Execute="deferred" Impersonate="no" />
        <SetProperty Id="CopyCscPlugin" Before="CopyCscPlugin" Value="[COPY_CSC_PLUGIN_DATA]" Sequence="execute"/>
        
        <InstallExecuteSequence>
          <Custom Action="ExtractCaResources" After="FindRelatedProducts" />
          <Custom Action="CollectUCData" After="ExtractCaResources">
            (REMOVE~="ALL") AND (NOT UPGRADINGPRODUCTCODE)
          </Custom>
          <Custom Action="DetectInvalidSideGrade" After="ExtractCaResources">
            WIX_UPGRADE_DETECTED
          </Custom>
          <Custom Action="DetectInvalidOS" After="ExtractCaResources" />
          <Custom Action="SetCacheDirectory" After="ExtractCaResources" />

          <Custom Action="SendEventOnUninstallError" OnExit="error">
            (REMOVE~="ALL") AND (NOT UPGRADINGPRODUCTCODE)
          </Custom>
          <Custom Action="SendEventOnUninstallComplete" After="InstallFinalize">
            (REMOVE~="ALL") AND (NOT UPGRADINGPRODUCTCODE)
          </Custom>
          <Custom Action="RemoveCaResources" OnExit="success" />

          <Custom Action="SetupRemoveCscPluginData" After="InstallInitialize">
            (REMOVE~="ALL") OR (UPGRADINGPRODUCTCODE)
          </Custom>
          <Custom Action="RemoveCscPlugin" After="SetupRemoveCscPluginData">
            (REMOVE~="ALL") OR (UPGRADINGPRODUCTCODE)
          </Custom>

          <Custom Action="SetupCopyCscPluginData" Before="InstallFinalize">
            (NOT REMOVE~="ALL")
          </Custom>
          <Custom Action="CopyCscPlugin" After="SetupCopyCscPluginData">
            (NOT REMOVE~="ALL")
          </Custom>
        </InstallExecuteSequence>

        <?if $(var.Platform) = x86 ?>
          <Condition Message="This application cannot be installed on an x64 machine.">
            <![CDATA[Not VersionNT64]]>
          </Condition>
        <?endif?>

        <!--=
        AllowSameVersionUpgrades:
        When set to no (the default), installing a product with the same version and upgrade code (but different product code) is allowed and treated by MSI as two products. 
        When set to yes, WiX sets the msidbUpgradeAttributesVersionMaxInclusive attribute, which tells MSI to treat a product with the same version as a major upgrade.

        This is useful when two product versions differ only in the fourth version field. 
        MSI specifically ignores that field when comparing product versions, so two products that differ only in the fourth version field are the same product and need this attribute set to yes to be detected.

        Note that because MSI ignores the fourth product version field, 
        setting this attribute to yes also allows downgrades when the first three product version fields are identical. 
        For example, product version 1.0.0.1 will "upgrade" 1.0.0.2998 because they're seen as the same version (1.0.0). 
        That could reintroduce serious bugs so the safest choice is to change the first three version fields and omit this attribute to get the default of no.
        
        Schedule="afterInstallExecute":
        Schedules RemoveExistingProducts between the InstallExecute and InstallFinalize standard actions. 
        This scheduling installs the upgrade product "on top of" the installed product then lets RemoveExistingProducts uninstall any components that don't also exist in the upgrade product. 
        Note that this scheduling requires strict adherence to the component rules because it relies on component reference counts to be accurate during installation of the upgrade product and removal of the installed product.
        If installation of the upgrade product fails, Windows Installer also rolls back the removal of the installed product - in other words, reinstalls it.
        -->
        <MajorUpgrade AllowDowngrades="no"
					  AllowSameVersionUpgrades="yes"
            Schedule="afterInstallExecute"
					  DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        
        <MediaTemplate EmbedCab="yes" />
    
        <Feature Id="UnifiedConnector" AllowAdvertise="no" Display="hidden" Level="1">
            <ComponentGroupRef Id="UnifiedConnectorComponents"/>
            <ComponentGroupRef Id="UCServiceComponents" />
            <ComponentGroupRef Id="UCIDComponents" />
            <ComponentGroupRef Id="UCIDx86Components"/>
            <?if $(var.Platform) = "x64" ?>
              <ComponentGroupRef Id="UCIDx64Components"/>
            <?endif?>
            <ComponentGroupRef Id="UCPMComponents" />
            <ComponentGroupRef Id="CG.ConfigFiles" />
            <ComponentGroupRef Id="CiscoStartMenu" />
            <ComponentGroupRef Id="CscPluginComponents" />
        </Feature>

        <Property Id="UC_BASE_DIRECTORY">
            <RegistrySearch Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)" Root="HKLM" Type="raw" Id="UC_BASE_DIRECTORY_REGSEARCH" Name="Path" />
        </Property>

        <?if $(var.UC_CONSUMER) = 1 ?>
            <!-- ARPSYSTEMCOMPONENT=1 prevents the application from being displayed in the Add or Remove Programs list of Control Panel -->
            <!-- Note that you must remove this property completely to show in the list again. setting 0 is not enough -->
            <Property Id="ARPSYSTEMCOMPONENT" Value="1" />
        <?endif ?>
      
        <!-- These properties disable Repair and Modify options -->
        <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
        <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />
    </Product>

    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.PlatformProgramFilesFolder)">
                <Directory Id="CISCO_DIRECTORY" Name="$(var.CiscoDirectory)">
                    <Directory Id="PRODUCT_FAMILY_DIRECTORY" Name="$(var.ProductDirectory)">
                        <Directory Id="UC_BASE_DIRECTORY" Name="$(var.UnifiedConnectorDirectory)">
                            <Directory Id="UC_CONFIG_DIRECTORY" Name="$(var.UCConfigDirectory)" />
                            <Directory Id="UC_DATA_DIRECTORY" Name="$(var.UCDataDirectory)" />
                            <Directory Id="UC_DIRECTORY" Name="$(var.Version)">
                                <Directory Id="UCSERVICE_BASE_DIRECTORY" Name="$(var.ServiceDictory)">
                                    <Directory Id="UCSERVICE_DIRECTORY" Name="$(var.ServiceVersion)" />
                                </Directory>
                                <Directory Id="UCID_BASE_DIRECTORY" Name="$(var.UCIDDirectory)">
                                    <Directory Id="UCID_DIRECTORY" Name="$(var.UCIDVersion)" >
                                        <Directory Id="UCID_DIRECTORY_X86" Name="x86" />
                                        <Directory Id="UCID_DIRECTORY_X64" Name="x64" />
                                    </Directory>
                                </Directory>
                                <Directory Id="UCPM_BASE_DIRECTORY" Name="$(var.UCPMDirectory)">
                                    <Directory Id="UCPM_DIRECTORY" Name="$(var.UCPMVersion)" />
                                </Directory>
                            </Directory>
                        </Directory>
                        <?if $(var.Platform) != x64?>
                            <Directory Id="CSC_PLUGIN_DIRECTORY" Name="$(var.CscPluginDirectory)" />
                        <?endif?>
                    </Directory>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
              <Directory Id="CiscoProgramMenuFolder" Name="$(var.CiscoDirectory)" />
            </Directory>
            <?if $(var.Platform) = x64?>
            <Directory Id="ProgramFilesFolder">
                <Directory Id="WIN32_CISCO_DIRECTORY" Name="$(var.CiscoDirectory)">
                    <Directory Id="WIN32_PRODUCT_FAMILY_DIRECTORY" Name="$(var.ProductDirectory)">
                        <Directory Id="CSC_PLUGIN_DIRECTORY" Name="$(var.CscPluginDirectory)" />
                    </Directory>
                </Directory>
            </Directory>
            <?endif?>
        </Directory>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="UnifiedConnectorComponents" Directory="UC_BASE_DIRECTORY">
            <Component Id="UC_PRODUCTCODE_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)">
                    <RegistryValue Type="string" Name="ProductCode" Value="[ProductCode]" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UC_LOG_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)">
                    <RegistryValue Type="string" Name="LogDir" Value="[UC_DATA_DIRECTORY]" KeyPath="yes"/>
                </RegistryKey>
            </Component>
          
            <Component Id="C.RemoveFiles">
                <RegistryValue Root="HKLM" 
                               Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)" 
                               Name="Path" Type="string" Value="[UC_BASE_DIRECTORY]" KeyPath="yes" />
                <util:RemoveFolderEx On="uninstall" Property="UC_BASE_DIRECTORY" />
                <util:RemoveFolderEx On="uninstall" Property="UC_INSTALLCACHE_DIR" />
            </Component>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="CscPluginComponents" Directory="UCSERVICE_DIRECTORY">
            <Component Id="CscCmPlugin" Guid="*">
                <File Id="csccmplugin.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)\Win32\$(var.Configuration)\csccmplugin.dll" />
            </Component>
        </ComponentGroup>

        <ComponentGroup Id="UCServiceComponents" Directory="UCSERVICE_DIRECTORY">
            <Component Id="UCSERVICE_VERSION_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMSERVICE">
                    <RegistryValue Type="string" Name="Version" Value="$(var.ServiceVersion)" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCSERVICE_PATH_REGISTRY" Guid="*">
              <RegistryKey Root="HKLM"
             Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMSERVICE">
                <RegistryValue Type="string" Name="Path" Value="[UCSERVICE_DIRECTORY]" KeyPath="yes"/>
              </RegistryKey>
            </Component>

            <Component Id="UCDT_SHORTCUT_PATH_REGISTRY" Guid="*">
              <RegistryKey Root="HKLM"
             Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMSERVICE">
                <RegistryValue Type="string" Name="ucdt Shortcut" Value="[CiscoProgramMenuFolder]!(loc.DiagToolName).lnk" KeyPath="yes"/>
              </RegistryKey>
            </Component>
          
            <Component Id="ucs.exe" Guid="*">
                <File Id="ucs.exe" Name="csc_cms.exe" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)\$(var.ProjectsPlatform)\$(var.Configuration)\csc_cms.exe" />
                <ServiceControl Id="StartService" Name="$(var.ServiceName)" Start="install" Stop="both" Remove="uninstall" Wait="no" />
                <ServiceInstall Id="ServiceInstaller" Name="$(var.ServiceName)" DisplayName="$(var.ProductName)" Type="ownProcess" Start="auto" ErrorControl="normal" Account="[SERVICEACCOUNT]" Password="[SERVICEPASSWORD]" Description="[CustomDescription]">
                    <util:ServiceConfig RestartServiceDelayInSeconds="60" FirstFailureActionType="restart" SecondFailureActionType="restart" ThirdFailureActionType="restart" />
                </ServiceInstall>
            </Component>

            <Component Id="csc_ucdt.exe" Guid="*">
              <File Id="csc_ucdt.exe" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)\$(var.ProjectsPlatform)\$(var.Configuration)\csc_cmdt.exe" >
                <!--= Set explanation above for Advertise="yes" -->
                <Shortcut Id="csc_ucdt_start_menu_shortcut" 
                          Name="!(loc.DiagToolName)" 
                          Description="!(loc.DiagToolDescription)" 
                          Directory="CiscoProgramMenuFolder" 
                          Advertise="yes" 
                          WorkingDirectory="UCSERVICE_DIRECTORY" >
                    <ShortcutProperty Key="System.AppUserModel.ID" Value="Cisco.CM"/>
                </Shortcut>
              </File>
            </Component>

            <?if $(var.Configuration) = "Release" ?>
                <Component Id="msvcp140.dll" Guid="*">
                    <File Id="msvcp140.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140.dll" />
                </Component>
                <Component Id="msvcp140_1.dll" Guid="*">
                    <File Id="msvcp140_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_1.dll" />
                </Component>
                <Component Id="msvcp140_2.dll" Guid="*">
                    <File Id="msvcp140_2.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_2.dll" />
                </Component>
                <Component Id="vcruntime140.dll" Guid="*">
                    <File Id="vcruntime140.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\vcruntime140.dll" />
                </Component>
                <?if $(var.Platform) = "x64" ?>
                    <!-- vcruntime140_1.dll does not have a x86 version, so only install it for x64 -->
                    <Component Id="vcruntime140_1.dll" Guid="*">
                        <File Id="vcruntime140_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\VC\vcruntime140_1.dll" />
                    </Component>
                <?endif?>
                <Component Id="ucrtbase.dll" Guid="*">
                    <File Id="ucrtbase.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.WLHBASE)\Redist\ucrt\DLLs\$(var.Platform)\ucrtbase.dll" />
                </Component>
            <?endif?>
            <?if $(var.Configuration) = "Debug" ?>
                <Component Id="msvcp140d.dll" Guid="*">
                    <File Id="msvcp140d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140d.dll" />
                </Component>
                <Component Id="msvcp140_1d.dll" Guid="*">
                    <File Id="msvcp140_1d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_1d.dll" />
                </Component>
                <Component Id="msvcp140_2d.dll" Guid="*">
                    <File Id="msvcp140_2d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_2d.dll" />
                </Component>
                <Component Id="vcruntime140d.dll" Guid="*">
                    <File Id="vcruntime140d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\vcruntime140d.dll" />
                </Component>
                <?if $(var.Platform) = "x64" ?>
                    <!-- vcruntime140_1d.dll does not have a x86 version, so only install it for x64 -->
                    <Component Id="vcruntime140_1d.dll" Guid="*">
                        <File Id="vcruntime140_1d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\VC\vcruntime140_1d.dll" />
                    </Component>
                <?endif?>
                <Component Id="ucrtbased.dll" Guid="*">
                    <File Id="ucrtbased.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.WLHBASE)\bin\10.0.19041.0\$(var.Platform)\ucrt\ucrtbased.dll" />
                </Component>
            <?endif?>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="UCIDComponents" Directory="UCID_DIRECTORY">
            <Component Id="UCID_VERSION_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID">
                    <RegistryValue Type="string" Name="Version" Value="$(var.UCIDVersion)" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCID_PATH_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID">
                    <RegistryValue Type="string" Name="Path" Value="[UCID_DIRECTORY]" KeyPath="yes"/>
                </RegistryKey>
            </Component>
            
            <Component Id="UCID_API_FILE_PATH_REGISTRY_X86" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID\x86">
                    <RegistryValue Type="string" Name="ucidapi" Value="[UCID_DIRECTORY_X86]cmidapi.dll" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCID_CONTROL_FILE_PATH_REGISTRY_X86" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID\x86">
                    <RegistryValue Type="string" Name="ucidcontrolplugin" Value="[UCID_DIRECTORY_X86]cmidcontrolplugin.dll" KeyPath="yes"/>
                </RegistryKey>
            </Component>
            
            <Component Id="UCID_API_FILE_PATH_REGISTRY_X64" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID\x64">
                    <RegistryValue Type="string" Name="ucidapi" Value="[UCID_DIRECTORY_X64]cmidapi.dll" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCID_CONTROL_FILE_PATH_REGISTRY_X64" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID\x64">
                    <RegistryValue Type="string" Name="ucidcontrolplugin" Value="[UCID_DIRECTORY_X64]cmidcontrolplugin.dll" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCID_DATA_DIR" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMID">
                    <RegistryValue Type="string" Name="DataDir" Value="[UC_DATA_DIRECTORY]" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="ucid.exe" Guid="*">
                <File Id="ucid.exe" Name="csc_cmid.exe" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\csc_cmid_$(var.Platform).exe" />
            </Component>

        </ComponentGroup>

        <ComponentGroup Id="UCIDx86Components" Directory="UCID_DIRECTORY_X86">
            <Component Id="ucidapi.dll.x86" Guid="*">
                <File Id="ucidapi.dll.x86" Name="cmidapi.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\cmidapi_x86.dll" />
            </Component>
            <?if $(var.Platform) != "x64" ?>
              <Component Id="ucidcontrolplugin.dll.x86" Guid="*">
                  <File Id="ucidcontrolplugin.dll.x86" Name="cmidcontrolplugin.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\cmidcontrolplugin_x86.dll" />
              </Component>
            <?endif?>
        </ComponentGroup>

        <?if $(var.Platform) = "x64" ?>
          <ComponentGroup Id="UCIDx64Components" Directory="UCID_DIRECTORY_X64">
              <Component Id="ucidapi.dll.x64" Guid="*">
                <File Id="ucidapi.dll.x64" Name="cmidapi.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\cmidapi_x64.dll" />
              </Component>
              <Component Id="ucidcontrolplugin.dll.x64" Guid="*">
                <File Id="ucidcontrolplugin.dll.x64" Name="cmidcontrolplugin.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\cmidcontrolplugin_x64.dll" />
              </Component>
          </ComponentGroup>
        <?endif?>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="UCPMComponents" Directory="UCPM_DIRECTORY">
            <Component Id="UCPM_VERSION_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMPM">
                    <RegistryValue Type="string" Name="Version" Value="$(var.UCPMVersion)" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="UCPM_DLL_PATH_REGISTRY" Guid="*">
                <RegistryKey Root="HKLM"
							 Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\CMPM">
                    <RegistryValue Type="string" Name="DllPath" Value="[UCPM_DIRECTORY]PM_MCP.dll" KeyPath="yes"/>
                </RegistryKey>
            </Component>
        
            <Component Id="PM_MCP.dll" Guid="*">
                <File Id="PM_MCP.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\PM_MCP.dll" />
            </Component>
            <Component Id="ucpm.exe" Guid="*">
                <File Id="ucpm.exe" Name="csc_pm.exe" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.SolutionDir)$(var.ProjectsPlatform)\$(var.Configuration)\csc_pm.exe" />
            </Component>
          
            <?if $(var.Configuration) = "Release" ?>
                <Component Id="UCPMmsvcp140.dll" Guid="*">
                  <File Id="UCPMmsvcp140.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140.dll" />
                </Component>
                <Component Id="UCPMmsvcp140_1.dll" Guid="*">
                  <File Id="UCPMmsvcp140_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_1.dll" />
                </Component>
                <Component Id="UCPMmsvcp140_2.dll" Guid="*">
                  <File Id="UCPMmsvcp140_2.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_2.dll" />
                </Component>
                <Component Id="UCPMvcruntime140.dll" Guid="*">
                  <File Id="UCPMvcruntime140.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\vcruntime140.dll" />
                </Component>
                <?if $(var.Platform) = "x64" ?>
                    <!-- vcruntime140_1.dll does not have a x86 version, so only install it for x64 -->
                    <Component Id="UCPMvcruntime140_1.dll" Guid="*">
                      <File Id="UCPMvcruntime140_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\VC\vcruntime140_1.dll" />
                    </Component>
                <?endif?>
                <Component Id="UCPMucrtbase.dll" Guid="*">
                  <File Id="UCPMucrtbase.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.WLHBASE)\Redist\ucrt\DLLs\$(var.Platform)\ucrtbase.dll" />
                </Component>
            <?endif?>
            <?if $(var.Configuration) = "Debug" ?>
                <Component Id="UCPMmsvcp140d.dll" Guid="*">
                  <File Id="UCPMmsvcp140d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140d.dll" />
                </Component>
                <Component Id="UCPMmsvcp140_1d.dll" Guid="*">
                  <File Id="UCPMmsvcp140_1d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_1d.dll" />
                </Component>
                <Component Id="UCPMmsvcp140_2d.dll" Guid="*">
                  <File Id="UCPMmsvcp140_2d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\msvcp140_2d.dll" />
                </Component>
                <Component Id="UCPMvcruntime140d.dll" Guid="*">
                  <File Id="UCPMvcruntime140d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\VC\vcruntime140d.dll" />
                </Component>
                <?if $(var.Platform) = "x64" ?>
                    <!-- vcruntime140_1d.dll does not have a x86 version, so only install it for x64 -->
                    <Component Id="UCPMvcruntime140_1d.dll" Guid="*">
                      <File Id="UCPMvcruntime140_1d.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\VC\vcruntime140_1d.dll" />
                    </Component>
                <?endif?>
                <Component Id="UCPMucrtbased.dll" Guid="*">
                  <File Id="UCPMucrtbased.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.WLHBASE)\bin\10.0.19041.0\$(var.Platform)\ucrt\ucrtbased.dll" />
                </Component>
                <Component Id="UCPMzlibd.dll" Guid="*">
                  <File Id="UCPMzlibd.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\$(var.ProjectsPlatform)\bin\zlibd.dll" />
                </Component>
          <?endif?>
            <?if $(var.Platform) = "x64" ?>
              <Component Id="UCPMlibcrypto_1_1_x64.dll" Guid="*">
                <File Id="UCPMlibcrypto_1_1_x64.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\libcrypto-1_1-x64.dll" />
              </Component>
              <Component Id="UCPMlibssl_1_1_x64.dll" Guid="*">
                <File Id="UCPMlibssl_1_1_x64.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\x64\bin\libssl-1_1-x64.dll" />
              </Component>
            <?else?>
              <Component Id="UCPMlibcrypto_1_1.dll" Guid="*">
                <File Id="UCPMlibcrypto_1_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\Win32\bin\libcrypto-1_1.dll" />
              </Component>
              <Component Id="UCPMlibssl_1_1.dll" Guid="*">
                <File Id="UCPMlibssl_1_1.dll" KeyPath="yes" Checksum="yes" DiskId="1" Source="$(var.IMN_COMMON)\common-windows-build\$(var.Configuration)\Win32\bin\libssl-1_1.dll" />
              </Component>
            <?endif?>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <!-- Configuration File Installation -->
        <!-- Copies files from the following properties: SERVICE_CONFIG, ID_CONFIG, PM_CONFIG. -->
        <!-- If Properties are empty, no files will be copied but configs will be missing -->
        <!-- If Properties set but files dont exist, installation will fail -->
        <!-- Config Files are kept on upgrades but uninstalled on uninstall -->
        <ComponentGroup Id="CG.ConfigFiles" Directory="UC_CONFIG_DIRECTORY">
            <!-- Registry Keys That point to each Config File -->
            <!-- The Registry key will still be writen if the file doesnt exist -->
            <Component Id="C.Registry.Config" Guid="*">
                <RegistryKey Root="HKLM" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\config">
                    <RegistryValue Type="string" Name="path" Value="[UC_CONFIG_DIRECTORY]" KeyPath="yes"/>
                </RegistryKey>
            </Component>
            
            <Component Id="C.Registry.BSConfig" Guid="*">
                <RegistryKey Root="HKLM" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\config">
                    <RegistryValue Type="string" Name="Bootstrapper" Value="[UC_CONFIG_DIRECTORY]$(var.BootstrapperConfigName)" KeyPath="yes"/>
                </RegistryKey>
            </Component>
            
            <Component Id="C.Registry.ServiceConfig" Guid="*">
                <RegistryKey Root="HKLM" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\config">
                    <RegistryValue Type="string" Name="Service" Value="[UC_CONFIG_DIRECTORY]$(var.UCServiceConfigName)" KeyPath="yes"/>
                </RegistryKey>
            </Component>
            
            <Component Id="C.Registry.UCPMConfig" Guid="*">
                <RegistryKey Root="HKLM" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\config">
                    <RegistryValue Type="string" Name="CMPM" Value="[UC_CONFIG_DIRECTORY]$(var.UCServiceConfigName)" KeyPath="yes"/>
                </RegistryKey>
            </Component>

            <Component Id="C.Registry.UCIDConfig" Guid="*">
                <RegistryKey Root="HKLM" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)\config">
                    <RegistryValue Type="string" Name="CMID" Value="[UC_CONFIG_DIRECTORY]$(var.UCServiceConfigName)" KeyPath="yes"/>
                </RegistryKey>
            </Component>
          
            <!-- Bootstrapper Config Management -->
            <Component Id="C.BootstrapperConfig" Guid="3D8A1726-FCE9-4E4A-BA9E-07F3CF732617">
                <CopyFile Id="CF.BootstrapperConfig" SourceProperty="BS_CONFIG" DestinationDirectory="UC_CONFIG_DIRECTORY" DestinationName="$(var.BootstrapperConfigName)"/>
                <Condition>BS_CONFIG AND <![CDATA[BS_CONFIG <> ""]]></Condition>
            </Component>

            <Component Id="C.Remove.BootstrapperConfig" Guid="D37A0F1E-EF10-479F-B1EF-D48D29A20086">
                <RemoveFile Id="RF.BootstrapperConfig" Name="$(var.BootstrapperConfigName)" On="uninstall"/>
            </Component>
            
            <!-- UCService, UCPM, UCID Config Management -->
            <Component Id="C.UCServiceConfig" NeverOverwrite="yes">
                <File Id="cm_config.json" KeyPath="yes" Checksum="no" DiskId="1" Source="$(var.SolutionDir)Resources\config\cm_config.json" />
            </Component>
        </ComponentGroup>
    </Fragment>

  <Fragment>
    <ComponentGroup Id="CiscoStartMenu" Directory="CiscoProgramMenuFolder">
      <Component Id="CiscoProgramMenuFolder" Guid="87C0183A-06EA-4616-ACBA-E34EE127C861">
        <RemoveFolder Id="CiscoProgramMenuFolder" On="uninstall" />
        <RegistryValue Root="HKMU" Key="Software\Cisco\$(var.ProductFamily)\$(var.InstallName)" Name="InstalledStartMenuShortcuts" Type="integer" Value="1" />
      </Component>
    </ComponentGroup>
  </Fragment>
</Wix>
