#!/usr/bin/env groovy

@Library('JenkinsShared')_

agentLabel = "windowsci2019"

def CheckoutDependencies() {
  getAmpBuildTools(env.JENKINS_USERNAME, env.JENKINS_USER_PASSWORD)
  powershell ".\\AmpRepositorySync.exe -cws ."
  powershell ".\\AmpRepositorySync.exe -cc latest"
}

def SetupVersion( int ucMajor, int ucMinor, int ucPatch, int ucRev ) {
  dir('WindowsUnifiedConnector') {
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: 'Version=\\"(\\d+.\\d+.\\d+.\\d+)', replace: 'Version="' + ucMajor + '.' + ucMinor + '.' + ucPatch + '.' + ucRev, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'Install\\Tests\\TestPackageBootstrapper\\Bundle.wxs') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: 'Version=\\"(\\d+.\\d+.\\d+.\\d+)', replace: 'Version="' + ucMajor + '.' + ucMinor + '.' + ucPatch + '.' + ucRev, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'Install\\Tests\\TestPackageA\\Product.wxs') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: 'Version=\\"(\\d+.\\d+.\\d+.\\d+)', replace: 'Version="' + ucMajor + '.' + ucMinor + '.' + ucPatch + '.' + ucRev, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'Install\\Tests\\TestPackageB\\Product.wxs') ])
  }
}

pipeline {
  agent none
  options {
    checkoutToSubdirectory('WindowsUnifiedConnector')
    timeout(time: 4, unit: 'HOURS')
    buildDiscarder(logRotator(numToKeepStr:'10'))
  }
  environment {
    BUILD_LOG_LINES         = '500'

    MASTER_BRANCH_NAME      = 'master'
    LOCAL_CERT_LOCATION = 'C:\\machineCerts'
    CERT_FILENAME = 'MyCA.cer'

    JENKINS_USERNAME = 'Jenkins'
    JENKINS_USER_PASSWORD = credentials('JENKINS_USER_PASSWORD')
    GITHUB_STATUS_API_KEY = credentials('GITHUB_STATUS_OAUTH_API_KEY')
    WIN_DEV_GITHUB_TOKEN = credentials('fireamp-win-dev-git-token')
    CLG5_LAB_PASSWORD = credentials('CLG5_LAB_GENERIC_USER_PW')
    CLG5_SHARE_BUILD_LOCATION = '\\\\clg5-lab-fserv1.cisco.com\\public\\WinUCBuild\\Automation'
  }
  stages {
    stage ('Init') {
      agent {
        label 'master'
      }
      steps {
        script {
          abortPreviousBuilds()
        }
      }
    }
    stage ('Build Packages') {
      agent {
        node {
          label "${agentLabel}"
        }
      }
      stages {
        stage ('Setup') {
          steps {
            script {
              powershell "gci env:"
              connectClgShare()
              CheckoutDependencies()
              dir('WindowsUnifiedConnector') {
                powershell "git clean -dfx"
                powershell 'Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -Outfile "nuget.exe"'
                powershell ".\\nuget.exe restore WindowsUnifiedConnector.sln"
              }
              SetupVersion(1,0,0,0)
            }
          }
        }
        stage ('Build 1.0.0.0') {
          steps {
            script {
              dir('WindowsUnifiedConnector\\Install\\Tests') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageA"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x64 -target:TestPackageA"
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageB"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x64 -target:TestPackageB"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageBootstrapper"
				
				bat "RENAME TestPackageA\\bin\\x86\\Release\\TestPackageA.msi TestPackageA-x86-1.0.0.0.msi"
				bat "RENAME TestPackageA\\bin\\x64\\Release\\TestPackageA.msi TestPackageA-x64-1.0.0.0.msi"
                bat "RENAME TestPackageB\\bin\\x86\\Release\\TestPackageB.msi TestPackageB-x86-1.0.0.0.msi"
				bat "RENAME TestPackageB\\bin\\x64\\Release\\TestPackageB.msi TestPackageB-x64-1.0.0.0.msi"
				bat "RENAME TestPackageBootstrapper\\bin\\Release\\TestPackageBootstrapper.exe TestPackageBootstrapper-1.0.0.0.exe"
              }
              
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageA\\bin\\x86\\Release\\TestPackageA-x86-1.0.0.0.msi', fingerprint: true
			  archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageA\\bin\\x64\\Release\\TestPackageA-x64-1.0.0.0.msi', fingerprint: true
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageB\\bin\\x86\\Release\\TestPackageB-x86-1.0.0.0.msi', fingerprint: true
			  archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageB\\bin\\x64\\Release\\TestPackageB-x64-1.0.0.0.msi', fingerprint: true
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageBootstrapper\\bin\\Release\\TestPackageBootstrapper-1.0.0.0.exe', fingerprint: true
            }
          }
        }
        stage ('Build 2.0.0.0') {
          steps {
            script {
              SetupVersion(2,0,0,0)
              dir('WindowsUnifiedConnector\\Install\\Tests') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageA"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x64 -target:TestPackageA"
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageB"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x64 -target:TestPackageB"
				bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe TestPackages.sln /p:Configuration=Release /p:Platform=x86 -target:TestPackageBootstrapper"
                
				bat "RENAME TestPackageA\\bin\\x64\\Release\\TestPackageA.msi TestPackageA-x64-2.0.0.0.msi"
				bat "RENAME TestPackageA\\bin\\x86\\Release\\TestPackageA.msi TestPackageA-x86-2.0.0.0.msi"
                bat "RENAME TestPackageB\\bin\\x64\\Release\\TestPackageB.msi TestPackageB-x64-2.0.0.0.msi"
				bat "RENAME TestPackageB\\bin\\x86\\Release\\TestPackageB.msi TestPackageB-x86-2.0.0.0.msi"
				bat "RENAME TestPackageBootstrapper\\bin\\Release\\TestPackageBootstrapper.exe TestPackageBootstrapper-2.0.0.0.exe"
              }
              
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageA\\bin\\x86\\Release\\TestPackageA-x86-2.0.0.0.msi', fingerprint: true
			  archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageA\\bin\\x64\\Release\\TestPackageA-x64-2.0.0.0.msi', fingerprint: true
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageB\\bin\\x86\\Release\\TestPackageB-x86-2.0.0.0.msi', fingerprint: true
			  archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageB\\bin\\x64\\Release\\TestPackageB-x64-2.0.0.0.msi', fingerprint: true
              archiveArtifacts artifacts: 'WindowsUnifiedConnector\\Install\\Tests\\TestPackageBootstrapper\\bin\\Release\\TestPackageBootstrapper-2.0.0.0.exe', fingerprint: true
            }
          }
        }
      }
      post {
        cleanup {
          cleanWs cleanWhenAborted: true, cleanWhenFailure: false, cleanWhenSuccess: true
        }
      }
    }
  }
}