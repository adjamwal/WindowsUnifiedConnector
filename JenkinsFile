#!/usr/bin/env groovy

@Library('JenkinsShared')_

agentLabel = "VS2019"

def SetGithubPendingStatus() {
  if (env.CHANGE_ID != null) {
    last_stage = env.STAGE_NAME
    echo "Setting Github PR Pending Status: ${last_stage}"
    pullRequest.createStatus( status: 'pending', context: "WinJenkins/CI", description: "Build Stage: ${last_stage}", targetUrl: "${env.JOB_URL}" )
  }
}

def SetGithubSuccessStatus() {
  if (env.CHANGE_ID != null) {
    echo "Setting Github PR Success Status"
    pullRequest.createStatus( status: 'success', context: "WinJenkins/CI", description: "Build Completed", targetUrl: "${env.JOB_URL}" )
  }
}

def SetGithubFailureStatus() {
  if (env.CHANGE_ID != null) {
    echo "Setting Github PR Failure Status: ${last_stage}"
    pullRequest.createStatus( status: 'failure', context: "WinJenkins/CI", description: "Failed on: ${last_stage}", targetUrl: "${env.JOB_URL}" )
  }
}

def CheckoutDependencies() {
  getAmpBuildTools(env.JENKINS_USERNAME, env.JENKINS_USER_PASSWORD)
  powershell ".\\AmpRepositorySync.exe -cws ."
  powershell ".\\AmpRepositorySync.exe -cc latest"
}

def SetupVersion( boolean upgrade ) {
  dir('WindowsUnifiedConnector') {
    //Setup GlobalVersion.h
    //Note: Can't use custom environment variables like ${UC_MAJOR} in contentReplace
    def ucMajor = UC_MAJOR
    def ucMinor = UC_MINOR
    def ucPatch = UC_PATCH

    if ( upgrade ) {
      ucMajor = 99
      ucMinor = 0
      ucPatch = 0
    }
    else if (env.CHANGE_ID != null) {
      ucMajor = 9
      ucMinor = 0
      ucPatch = 0
    }
                
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(FILEVER).+(\\d+,\\d+,\\d+,\\d+)', replace: 'FILEVER\t\t' + ucMajor + ',' + ucMinor + ',' + ucPatch + ',${BUILD_ID}', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(PRODUCTVER).+(\\d+,\\d+,\\d+,\\d+)', replace: 'PRODUCTVER\t' + ucMajor + ',' + ucMinor + ',' + ucPatch + ',${BUILD_ID}', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRFILEVER).+\\"(\\d+, \\d+, \\d+, \\d+)', replace: 'STRFILEVER\t"' + ucMajor + ', ' + ucMinor + ', ' + ucPatch + ', ${BUILD_ID}', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRPRODUCTVER).+\\"(\\d+, \\d+, \\d+, \\d+)', replace: 'STRPRODUCTVER\t"' + ucMajor + ', ' + ucMinor + ', ' + ucPatch + ', ${BUILD_ID}', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRFORMATPRODVER).+L\\"(\\d+.\\d+.\\d+.\\d+)', replace: 'STRFORMATPRODVER\tL"' + ucMajor + '.' + ucMinor + '.' + ucPatch + '.${BUILD_ID}', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])

    // contentReplace removes the last newline which is required
    bat 'echo. >> GlobalVersion.h'
  }
}

pipeline {
  agent none
  options {
    checkoutToSubdirectory('WindowsUnifiedConnector')
    timeout(time: 4, unit: 'HOURS')
    buildDiscarder(logRotator(numToKeepStr:'10'))
  }
  environment {
    UC_MAJOR = 0
    UC_MINOR = 0
    UC_PATCH = 1
    
    NOTIFICATION_RECIPIENTS = 'fireamp-dev-connector-win@cisco.com'
    BUILD_LOG_LINES         = '500'

    MASTER_BRANCH_NAME      = 'master'
    LOCAL_CERT_LOCATION = 'C:\\machineCerts'
    CERT_FILENAME = 'MyCA.cer'

    SKIP_CI = '[noci]'
    FORCE_COVERAGE = '[coverage]'
    FORCE_COVERITY = '[coverity]'
    FORCE_UPGRADE = '[upgrade]'
    JENKINS_USERNAME = 'Jenkins'
    JENKINS_USER_PASSWORD = credentials('JENKINS_USER_PASSWORD')
    GITHUB_STATUS_API_KEY = credentials('GITHUB_STATUS_OAUTH_API_KEY')
    WIN_DEV_GITHUB_TOKEN = credentials('fireamp-win-dev-git-token')
    CLG5_LAB_PASSWORD = credentials('CLG5_LAB_GENERIC_USER_PW')
    CLG5_SHARE_BUILD_LOCATION = '\\\\clg5-lab-fserv1.cisco.com\\public\\WinUCBuild\\Automation'
  }
  stages {
    stage ('Init') {
      agent {
        label 'master'
      }
      steps {
        script {
          abortPreviousBuilds()
          SetGithubPendingStatus()
          email.setupChangeAuthorEmail()

          if (env.CHANGE_ID != null) {
            if (env.CHANGE_TITLE.toLowerCase().contains(env.SKIP_CI)) {
              echo "${SKIP_CI} found in pull request title, ending build early as this is considered a no ci change"
              currentBuild.result = 'SUCCESS'
              env.CHANGE_AUTHOR_EMAIL = ''
              SetGithubSuccessStatus()
              return;
            }
          } else {
            //TODO: Enable when we have a branch build agent
            //TODO: Set production signer cerdentials on branch builds
            //agentLabel = "branchBuildEnabled"
          }
        }
      }
    }
    stage ('Build UC') {
      agent {
        node {
          label "${agentLabel}"
        }
      }
      stages {
        stage ('Setup') {
          steps {
            script {
              SetGithubPendingStatus()
              powershell "gci env:"
              connectClgShare()
              CheckoutDependencies()
              dir('WindowsUnifiedConnector') {
                powershell "git clean -dfx"
                powershell 'Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -Outfile "nuget.exe"'
                powershell ".\\nuget.exe restore WindowsUnifiedConnector.sln"
              }
              SetupVersion(false)
            }
          }
        }
        stage ('Build Release x86') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 -m'
              }                
            }
          }
        }
        stage ('Build Release x64') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 -m'
              }                
            }
          }
        }
        stage ('Build Debug x86') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Debug /p:Platform=x86 -m'
              }                
            }
          }
        }
        stage ('Build Debug x64') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Debug /p:Platform=x64 -m'
              }                
            }
          }
        }
        stage ('Test') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                //TODO: Enable unit tests when we have them
                // bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && vstest.console x86\\Debug\\Test*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common'
                // bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && vstest.console x64\\Debug\\Test*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common'
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && vstest.console x64\\Debug\\ComponentTest*.exe /logger:trx /Platform:x86 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common'
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && vstest.console x64\\Debug\\ComponentTest*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common'
              }                
            }
          }
        }
        stage ('Archive') {
          steps {
            script {
              SetGithubPendingStatus()
              
              bat "if not exist ${env.CLG5_SHARE_BUILD_LOCATION} ( mkdir ${env.CLG5_SHARE_BUILD_LOCATION} )"
              if (env.CHANGE_ID != null) {
                BUILD_PATH = "${env.CLG5_SHARE_BUILD_LOCATION}\\${env.CHANGE_ID}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
              else {
                BUILD_PATH = "${env.CLG5_SHARE_BUILD_LOCATION}\\${env.BRANCH_NAME}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
              
              if (env.BUILD_NUMBER != null) {
                BUILD_PATH = "${BUILD_PATH}\\${env.BUILD_NUMBER}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
                  
              dir('WindowsUnifiedConnector') {
                powershell 'Compress-Archive -Path "Win32\\Debug" -DestinationPath "Debug-Win32.zip"'
                powershell 'Compress-Archive -Path "x64\\Debug" -DestinationPath "Debug-x64.zip"'
                powershell 'Compress-Archive -Path "Win32\\Release" -DestinationPath "Release-Win32.zip"'
                powershell 'Compress-Archive -Path "x64\\Release" -DestinationPath "Release-x64.zip"'
                
                archiveArtifacts artifacts: '*.zip', fingerprint: true
                
                bat "COPY Install\\Installer\\bin\\x64\\Release\\en-us\\Cisco-UC-Installer-x64.msi ${BUILD_PATH} /Y"
                bat "COPY Install\\Installer\\bin\\x86\\Release\\en-us\\Cisco-UC-Installer-x86.msi ${BUILD_PATH} /Y"
                bat "COPY x64\\Release\\Cisco-UC-Installer.exe ${BUILD_PATH} /Y"
              }
              
              archiveArtifacts artifacts: '**\\Release\\**\\Cisco-UC-Installer*.msi', fingerprint: true
              archiveArtifacts artifacts: '**\\Release\\**\\Cisco-UC-Installer.exe', fingerprint: true
            }
          }
        }
        stage ('Upgrade Builds') {
          when {
            anyOf {
              not { changeRequest() }
              expression { env.CHANGE_TITLE.toLowerCase().contains(env.FORCE_UPGRADE) }
            }
          }
          steps {
            script {
              SetGithubPendingStatus()
              SetupVersion(true)
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 /t:rebuild -m'
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 /t:rebuild -m'
                
                bat "RENAME Install\\Installer\\bin\\x64\\Release\\en-us\\Cisco-UC-Installer-x64.msi Cisco-UC-Installer-x64-Upgrade.msi"
                bat "RENAME Install\\Installer\\bin\\x86\\Release\\en-us\\Cisco-UC-Installer-x86.msi Cisco-UC-Installer-x86-Upgrade.msi"
                bat "RENAME x64\\Release\\Cisco-UC-Installer.exe Cisco-UC-Installer-Upgrade.exe"
              }

              archiveArtifacts artifacts: '**\\Release\\**\\Cisco-UC-Installer*.msi', fingerprint: true
              archiveArtifacts artifacts: '**\\Release\\**\\Cisco-UC-Installer*.exe', fingerprint: true
            }
          }
        }
      }
      post {
        cleanup {
          cleanWs cleanWhenAborted: true, cleanWhenFailure: false, cleanWhenSuccess: true
        }
      }
    }
  }
  post {
    success {
      script {
        SetGithubSuccessStatus()
        email.sendSuccessEmail("fireamp-win-connector")
      }
    }
    failure {
      script {
        email.sendFailureEmail("fireamp-win-connector")
      }
    }
  }
}