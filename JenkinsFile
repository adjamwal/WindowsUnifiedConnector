#!/usr/bin/env groovy

@Library('JenkinsShared')_

agentLabel = "windowsci2019"

def SetGithubPendingStatus() {
  if (env.CHANGE_ID != null) {
    last_stage = env.STAGE_NAME
    echo "Setting Github PR Pending Status: ${last_stage}"
    pullRequest.createStatus( status: 'pending', context: "WinJenkins/CI", description: "Build Stage: ${last_stage}", targetUrl: "${env.JOB_URL}" )
  }
}

def SetGithubSuccessStatus() {
  if (env.CHANGE_ID != null) {
    echo "Setting Github PR Success Status"
    pullRequest.createStatus( status: 'success', context: "WinJenkins/CI", description: "Build Completed", targetUrl: "${env.JOB_URL}" )
  }
}

def SetGithubFailureStatus() {
  if (env.CHANGE_ID != null) {
    echo "Setting Github PR Failure Status: ${last_stage}"
    pullRequest.createStatus( status: 'failure', context: "WinJenkins/CI", description: "Failed on: ${last_stage}", targetUrl: "${env.JOB_URL}" )
  }
}

def CheckoutDependencies() {
  getAmpBuildTools(env.JENKINS_USERNAME, env.JENKINS_USER_PASSWORD)
  powershell ".\\AmpRepositorySync.exe -cws ."
  powershell ".\\AmpRepositorySync.exe -cc latest"
}

def SetupVersion( boolean upgrade ) {
  dir('WindowsUnifiedConnector') {
    //Setup GlobalVersion.h
    //Note: Can't use custom environment variables like ${UC_MAJOR} in contentReplace
    ucMajor = UC_MAJOR
    ucMinor = UC_MINOR
    ucPatch = UC_PATCH

    if ( upgrade ) {
      if (env.IMMUNET == '1') {
        ucMajor = 98
      }
      else {
        ucMajor = 99
      }
      ucMinor = 0
    }
    else if (env.CHANGE_ID != null) {
      ucMajor = 9
      ucMinor = 0
    }

    buildId = env.BUILD_ID
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(FILEVER).+(\\d+,\\d+,\\d+,\\d+)', replace: 'FILEVER\t\t' + ucMajor + ',' + ucMinor + ',' + ucPatch + ',' + buildId, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(PRODUCTVER).+(\\d+,\\d+,\\d+,\\d+)', replace: 'PRODUCTVER\t' + ucMajor + ',' + ucMinor + ',' + ucPatch + ',' + buildId, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRFILEVER).+\\"(\\d+, \\d+, \\d+, \\d+)', replace: 'STRFILEVER\t"' + ucMajor + ', ' + ucMinor + ', ' + ucPatch + ', ' + buildId, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRPRODUCTVER).+\\"(\\d+, \\d+, \\d+, \\d+)', replace: 'STRPRODUCTVER\t"' + ucMajor + ', ' + ucMinor + ', ' + ucPatch + ', ' + buildId, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])
    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(STRFORMATPRODVER).+L\\"(\\d+.\\d+.\\d+.\\d+)', replace: 'STRFORMATPRODVER\tL"' + ucMajor + '.' + ucMinor + '.' + ucPatch + '.' + buildId, matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'GlobalVersion.h') ])

    // contentReplace removes the last newline which is required
    bat 'echo. >> GlobalVersion.h'
  }
}

pipeline {
  agent none
  options {
    checkoutToSubdirectory('WindowsUnifiedConnector')
    timeout(time: 4, unit: 'HOURS')
    buildDiscarder(logRotator(numToKeepStr:'100'))
  }
  parameters {
    choice(name: 'IMMUNET', choices: ['0', '1'], description: 'Create Immunet UC build')
  }
  environment {
    NOTIFICATION_RECIPIENTS = 'fireamp-dev-connector-win@cisco.com'
    BUILD_LOG_LINES         = '500'

    MASTER_BRANCH_NAME      = 'master'
    LOCAL_CERT_LOCATION = 'C:\\machineCerts'
    CERT_FILENAME = 'MyCA.cer'

    SKIP_CI = '[noci]'
    FORCE_COVERAGE = '[coverage]'
    FORCE_COVERITY = '[coverity]'
    FORCE_UPGRADE = '[upgrade]'
    JENKINS_USERNAME = 'Jenkins'
    JENKINS_USER_PASSWORD = credentials('JENKINS_USER_PASSWORD')
    GITHUB_STATUS_API_KEY = credentials('GITHUB_STATUS_OAUTH_API_KEY')
    WIN_DEV_GITHUB_TOKEN = credentials('fireamp-win-dev-git-token')
    CLG5_LAB_PASSWORD = credentials('CLG5_LAB_GENERIC_USER_PW')
    SIGNING_API_PASSWORD = credentials('VSPHERE_GENERIC_ACCOUNT')
    CLG5_SHARE_BUILD_LOCATION = '\\\\clg5-lab-fserv1.cisco.com\\public\\WinUCBuild\\Automation'
    WIN_AMP_OFFICIAL_BUILD = "${env.CHANGE_ID != null ? 0 : 1}"
    IMMUNET = "${params.IMMUNET}"

    UC_MAJOR = 1
    UC_MINOR = 0
    UC_PATCH = "${params.IMMUNET == '1' ? 0 : 1}"
    UC_COMPANY = "${params.IMMUNET == '1' ? 'Immunet' : 'Cisco'}"
  }
  stages {
    stage ('Init') {
      agent {
        label 'master'
      }
      steps {
        script {
          abortPreviousBuilds()
          SetGithubPendingStatus()
          email.setupChangeAuthorEmail()

          if (env.CHANGE_ID != null) {
            if (env.CHANGE_TITLE.toLowerCase().contains(env.SKIP_CI)) {
              echo "${SKIP_CI} found in pull request title, ending build early as this is considered a no ci change"
              currentBuild.result = 'SUCCESS'
              env.CHANGE_AUTHOR_EMAIL = ''
              SetGithubSuccessStatus()
              return;
            }
          } else {
            agentLabel = "branchBuildEnabled2019"
			
            throttle(['BuildNumberManagment']) {
              node("master") {
                updateBuildNumber( "UnifiedConnector" )
              }
            }
          }
        }
      }
    }
    stage ('Build UC') {
      agent {
        node {
          label "${agentLabel}"
        }
      }
      stages {
        stage ('Setup') {
          steps {
            script {
              SetGithubPendingStatus()
              powershell "gci env:"
              connectClgShare()
              CheckoutDependencies()
              dir('WindowsUnifiedConnector') {
                powershell "git clean -dfx"
                powershell 'Invoke-WebRequest -Uri "https://dist.nuget.org/win-x86-commandline/latest/nuget.exe" -Outfile "nuget.exe"'
                powershell ".\\nuget.exe restore WindowsUnifiedConnector.sln"
                if (env.IMMUNET == '1') {
                    contentReplace( configs: [ fileContentReplaceConfig( configs: [ fileContentReplaceItemConfig( search: '(<UC_CONSUMER>0<\\/UC_CONSUMER>)', replace: '<UC_CONSUMER>1</UC_CONSUMER>', matchCount: 1) ], fileEncoding: 'UTF-8', filePath: 'Directory.Build.props') ])
                }
              }
              SetupVersion(false)
              currentBuild.description = "${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}"
            }
          }
        }
        stage ('Build Release x86') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 -m"
              }                
            }
          }
        }
        stage ('Build Release x64') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 -m"
              }                
            }
          }
        }
        stage ('Build Debug x86') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Debug /p:Platform=x86 -m"
              }                
            }
          }
        }
        stage ('Build Debug x64') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Debug /p:Platform=x64 -m"
              }                
            }
          }
        }
        stage ('Test') {
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                bat "set PATH=${WORKSPACE}\\common\\common-windows-build\\Release\\Win32\\bin;%PATH% && \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && vstest.console Win32\\Debug\\Test*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common"
                bat "set PATH=${WORKSPACE}\\common\\common-windows-build\\Release\\x64\\bin;%PATH% && \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && vstest.console x64\\Debug\\Test*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common"
                bat "set PATH=${WORKSPACE}\\common\\common-windows-build\\Debug\\Win32\\bin;%PATH% && \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && vstest.console Win32\\Debug\\ComponentTest*.exe /logger:trx /Platform:x86 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common"
                bat "set PATH=${WORKSPACE}\\common\\common-windows-build\\Debug\\x64\\bin;%PATH% && \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && vstest.console x64\\Debug\\ComponentTest*.exe /logger:trx /Platform:x64 /TestAdapterPath:packages\\GoogleTestAdapter.0.18.0\\build\\_common"
              }                
            }
          }
        }
        stage ('Archive') {
          steps {
            script {
              SetGithubPendingStatus()
              
              bat "if not exist ${env.CLG5_SHARE_BUILD_LOCATION} ( mkdir ${env.CLG5_SHARE_BUILD_LOCATION} )"
              if (env.CHANGE_ID != null) {
                BUILD_PATH = "${env.CLG5_SHARE_BUILD_LOCATION}\\${env.CHANGE_ID}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
              else {
                BUILD_PATH = "${env.CLG5_SHARE_BUILD_LOCATION}\\${env.BRANCH_NAME}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
              
              if (env.BUILD_NUMBER != null) {
                BUILD_PATH = "${BUILD_PATH}\\${env.BUILD_NUMBER}"
                bat "if not exist ${BUILD_PATH} ( mkdir ${BUILD_PATH} )"
              }
                  
              dir('WindowsUnifiedConnector') {
                powershell 'Compress-Archive -Path "Win32\\Debug" -DestinationPath "Debug-Win32.zip"'
                powershell 'Compress-Archive -Path "x64\\Debug" -DestinationPath "Debug-x64.zip"'

                dir('Symbols') {
                  powershell "Move-Item -Path ..\\Win32\\Release\\ -Destination Win32"
                  powershell "Move-Item -Path ..\\x64\\Release\\ -Destination x64"
                  powershell "Move-Item -Path ..\\Resources\\UCID\\x86\\symbols\\ -Destination ucid\\x86"
                  powershell "Move-Item -Path ..\\Resources\\UCID\\x64\\symbols\\ -Destination ucid\\x64"
                }
                powershell 'Compress-Archive -Path "Symbols\\*" -DestinationPath "Symbols.zip"'
                
                archiveArtifacts artifacts: '*.zip', fingerprint: true

                bat "RENAME Install\\Installer\\bin\\x64\\Release\\en-us\\Cisco-UC-Installer-x64.msi ${UC_COMPANY}-UC-Installer-x64-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi"
                bat "RENAME Install\\Installer\\bin\\x86\\Release\\en-us\\Cisco-UC-Installer-x86.msi ${UC_COMPANY}-UC-Installer-x86-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi"
                
                bat "COPY Install\\Installer\\bin\\x64\\Release\\en-us\\${UC_COMPANY}-UC-Installer* ${BUILD_PATH} /Y"
                bat "COPY Install\\Installer\\bin\\x86\\Release\\en-us\\${UC_COMPANY}-UC-Installer* ${BUILD_PATH} /Y"
              }
              
              archiveArtifacts artifacts: "**\\Release\\**\\${UC_COMPANY}-UC-Installer*.msi", fingerprint: true
            }
          }
        }
        stage ('Publish') {
          when {
            not { changeRequest() }
          }
          steps {
            script {
              SetGithubPendingStatus()

              nexusArtifactUploader(
                nexusVersion: 'nexus3',
                protocol: 'https',
                nexusUrl: 'nexus.engine.sourcefire.com',
                groupId: "UnifiedConnector/Windows/${env.BRANCH_NAME}",
                version: "${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}",
                repository: 'raw',
                credentialsId: 'nexus_credentials',
                artifacts: [
                  [
                    artifactId: "${UC_COMPANY}-UC-Installer-x64",
                    classifier: '',
                    file: "WindowsUnifiedConnector\\Install\\Installer\\bin\\x64\\Release\\en-us\\${UC_COMPANY}-UC-Installer-x64-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi",
                    type: 'msi'
                  ],
                  [
                    artifactId: "${UC_COMPANY}-UC-Installer-x86",
                    classifier: '',
                    file: "WindowsUnifiedConnector\\Install\\Installer\\bin\\x86\\Release\\en-us\\${UC_COMPANY}-UC-Installer-x86-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi",
                    type: 'msi'
                  ]
                ]
              )
			}
          }
        }
        stage ('Prepare Symbols') {
          when {
            not { changeRequest() }
          }
          steps {
            script {
              SetGithubPendingStatus()
              dir('WindowsUnifiedConnector') {
                stash name: 'SymbolStash', includes: 'Symbols.zip'
              }
            }
          }
        }
        stage ('Upgrade Builds') {
          when {
            anyOf {
              not { changeRequest() }
              expression { env.CHANGE_TITLE.toLowerCase().contains(env.FORCE_UPGRADE) }
            }
          }
          steps {
            script {
              SetGithubPendingStatus()
              SetupVersion(true)
              dir('WindowsUnifiedConnector') {
                // Encountered a random build failure using the /t:rebuild target. Seems like libControlModule is cleaned but not rebuilt
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 /t:clean'
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 /t:clean'
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 -m"
                bat "\"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat\" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 -m"
                
                bat "RENAME Install\\Installer\\bin\\x64\\Release\\en-us\\Cisco-UC-Installer-x64.msi ${UC_COMPANY}-UC-Installer-x64-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi"
                bat "RENAME Install\\Installer\\bin\\x86\\Release\\en-us\\Cisco-UC-Installer-x86.msi ${UC_COMPANY}-UC-Installer-x86-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi"
              }

              archiveArtifacts artifacts: "**\\Release\\**\\${UC_COMPANY}-UC-Installer*.msi", fingerprint: true

              nexusArtifactUploader(
                nexusVersion: 'nexus3',
                protocol: 'https',
                nexusUrl: 'nexus.engine.sourcefire.com',
                groupId: "UnifiedConnector/Windows/${env.BRANCH_NAME}",
                version: "${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}",
                repository: 'raw',
                credentialsId: 'nexus_credentials',
                artifacts: [
                  [
                    artifactId: "${UC_COMPANY}-UC-Installer-x64",
                    classifier: '',
                    file: "WindowsUnifiedConnector\\Install\\Installer\\bin\\x64\\Release\\en-us\\${UC_COMPANY}-UC-Installer-x64-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi",
                    type: 'msi'
                  ],
                  [
                    artifactId: "${UC_COMPANY}-UC-Installer-x86",
                    classifier: '',
                    file: "WindowsUnifiedConnector\\Install\\Installer\\bin\\x86\\Release\\en-us\\${UC_COMPANY}-UC-Installer-x86-${ucMajor}.${ucMinor}.${ucPatch}.${BUILD_ID}.msi",
                    type: 'msi'
                  ]
                ]
              )
            }
          }
        }
        stage ('Upload Symbols') {
          when {
            not { changeRequest() }
            beforeAgent true
          }
          agent {
            label 'Windows-Symbol-Server-Slave'
          }
          steps {
            script {
              SetGithubPendingStatus()
              powershell "gci env:"

              try {
                dir('WindowsUnifiedConnector') {
                  powershell "git clean -dfx"
                  unstash 'SymbolStash'
                  powershell 'Expand-Archive -Path "Symbols.zip" -force'

                  bat "\"C:\\Program Files (x86)\\Windows Kits\\10\\Debuggers\\x64\\symstore.exe\" add /s C:\\SymbolStore\\dev\\ /compress /r /f Symbols\\* /t UnifiedConnector"
                }
              } catch (e) {
                currentBuild.result = 'FAILURE'
                throw e
              } finally {
                // Since this is on a different node, it needs its own clean up call
                cleanWs cleanWhenAborted: true, cleanWhenFailure: false, cleanWhenSuccess: true
              }
            }
          }
        }
        stage ('Coverity') {
          when {
            anyOf {
              not { changeRequest() }
                expression { env.CHANGE_TITLE.toLowerCase().contains(env.FORCE_COVERITY) }
            }
          }
          steps {
            script {
              dir('WindowsUnifiedConnector') {
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x86 /t:clean'
                bat '"C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Professional\\Common7\\Tools\\VsDevCmd.bat" && msbuild.exe WindowsUnifiedConnector.sln /p:Configuration=Release /p:Platform=x64 /t:clean'

                coverityHelper.analyzeUnifiedConnector("${env.BRANCH_NAME}", "${env.WORKSPACE}\\WindowsUnifiedConnector", 1, 1)
              }
            }
          }
        }
      }
      post {
        cleanup {
          cleanWs cleanWhenAborted: true, cleanWhenFailure: false, cleanWhenSuccess: true
        }
      }
    }
  }
  post {
    success {
      script {
        SetGithubSuccessStatus()
        email.sendSuccessEmail("fireamp-win-connector")
      }
    }
    failure {
      script {
        email.sendFailureEmail("fireamp-win-connector")
      }
    }
  }
}
